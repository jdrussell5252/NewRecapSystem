@page
@model NewRecap.Pages.AdminPages.BrowseRecapsModel
@{
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<div class="row text-center">
    <div class="col-12 d-flex justify-content-center align-items-center">
        <label class="form-label fs-1 me-2" id="LabelText">Browse Recaps</label>

        <!-- Little floating filter icon -->
        <button type="button"
        class="btn btn-outline-light btn-sm"
        id="filterToggleBtn">
            &#x1F50D; <!-- magnifying glass icon -->
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('filterToggleBtn');
    const card = document.getElementById('filterCard');

    if (btn && card) {
    btn.addEventListener('click', function () {
    card.classList.toggle('d-none'); // Bootstrap utility
    });
    }
    });

    // storeNumbers will be an array of store numbers from the server
    var storeNumbers = @Html.Raw(Model.StoreJson);

    document.addEventListener('DOMContentLoaded', () => {
    const el = document.querySelector('.js-employee-choices');
    new Choices(el, {
    removeItemButton: true,     // little “x” on tokens
    searchEnabled: true,
    shouldSort: true,
    placeholderValue: 'Type to search employees',
    searchPlaceholderValue: 'Search employees...'
    });
    });
</script>


<!-- Hidden filter card -->
<div id="filterCard" class="recap-filter-card d-none">
    <div class="col-12">
        <label class="form-label fs-4" id="LabelText">Filter Recaps</label>
    </div>
    <form method="get" class="row g-2 align-items-end">

        <div class="col-12 col-md-6">
            <label class="form-label" id="LabelText" asp-for="FilterWorkorderNumber">Workorder Number:</label>
            <input asp-for="FilterWorkorderNumber"
            type="number"
            class="form-control form-control-sm"
            placeholder="e.g. 123" />
        </div>


        <div class="col-12 col-md-6">
            <label class="form-label" id="LabelText" asp-for="FilterStoreNumber">Store:</label>
            <input asp-for="FilterStoreNumber"
            type="number"
            class="form-control form-control-sm"
            placeholder="e.g. 123" />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label" id="LabelText" asp-for="FilterDate">Date:</label>
            <input asp-for="FilterDate"
            type="date"
            class="form-control form-control-sm" />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label" id="LabelText" asp-for="FilterCustomer">Customer:</label>
            <input asp-for="FilterCustomer"
            type="text"
            class="form-control form-control-sm"
            placeholder="Customer name" />
        </div>

        <!--Technician Textbox-->
        <div class="col-12">
            <label class="form-label" id="LabelText">Technician:</label>
            <select asp-for="SelectedEmployeeIds"
            asp-items="Model.EmployeeOptions"
            class="form-select js-employee-choices"
            multiple>
            </select>
            <span asp-validation-for="SelectedEmployeeIds" class="text-danger"></span>
        </div>
        <!--End of Technician Textbox-->

        <div class="col-12 mt-1 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-sm me-1">Search</button>
            <a asp-page="./BrowseRecaps" class="btn btn-outline-light btn-sm">Clear</a>
        </div>
    </form>
</div>


@if (Model.Recaps.Count != 0)
{
    @foreach (var recap in @Model.Recaps)
    {

        @if (recap.IsHardwareRecap)
        {

            <div class="row my-2">
                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapWorkorderNumber">Workorder Number:</label>
                        <label class="form-label" id="LabelText">@recap.RecapWorkorderNumber</label>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapDate">Recap Date:</label>
                        <label class="form-label" id="LabelText">@recap.RecapDate.ToString("MM/dd/yyyy")</label>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapDescription">Recap Description:</label>
                        <label class="form-label" id="LabelText">@recap.RecapDescription</label>
                    </div>
                </div>
            </div>

            <div class="row my-2">
                <div class="col-12">
                    <label class="form-label" id="LabelText">@recap.RecapStoreLocation</label>
                </div>
            </div>

            <div class="row my-2">
                <div class="col-12">
                    <label class="form-label" id="LabelText">@Html.Raw(recap.Segments)</label>

                </div>
            </div>

            <div class="row my-2">
                <div class="col-12">
                    <label class="form-label" id="LabelText" asp-for="@recap.TotalWorkTime">Total Work Time:</label>
                    <label class="form-label" id="LabelText">@recap.TotalWorkTime Hour(s)</label>

                    @if (recap.TotalLunchTime > 0)
                    {
                        <label class="form-label" id="LabelText" asp-for="@recap.TotalLunchTime">| Total Lunch Time:</label>
                        <label class="form-label" id="LabelText">@recap.TotalLunchTime Hour(s)</label>
                    }

                    <label class="form-label" id="LabelText" asp-for="@recap.TotalRecapTime">| Total Recap Time:</label>
                    <label class="form-label" id="LabelText">@recap.TotalRecapTime Hour(s)</label>

                    <label class="form-label" id="LabelText" asp-for="@recap.TotalDriveTime">| Total Time:</label>
                    <label class="form-label" id="LabelText">@recap.TotalTime Hour(s)</label>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(recap.Hostname))
            {
                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.Hostname">Hostname:</label>
                        <label class="form-label" id="LabelText">@recap.Hostname</label>
                    </div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(recap.IP))
            {
                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.IP">IP:</label>
                        <label class="form-label" id="LabelText">@recap.IP</label>
                    </div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(recap.WAM))
            {
                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.WAM">WAM:</label>
                        <label class="form-label" id="LabelText">@recap.WAM</label>
                    </div>
                </div>
            }

            @if (recap.RecapAssetNumber > 0)
            {
                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapAssetNumber">Asset Number:</label>
                        <label class="form-label" id="LabelText">@recap.RecapAssetNumber</label>
                    </div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(recap.RecapSerialNumber))
            {
                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapSerialNumber">Serial Number:</label>
                        <label class="form-label" id="LabelText">@recap.RecapSerialNumber</label>
                    </div>
                </div>
            }

            <div class="col">
                <label class="form-label" id="LabelText" asp-for="@recap.RecapEmployees">Employees:</label>
                @foreach (var employees in recap.RecapEmployees)
                {
                    <span class="badge bg-secondary"> @employees</span>
                }
            </div>

            <!--ADMINPRIVS-->
            var isAdmin = ViewData["IsAdmin"] != null && (bool)ViewData["IsAdmin"];
            @if (isAdmin)
            {
                <!--<form method="post">
                    <button class="deleteBtn btn-danger"
                            onclick="return confirm('Are you sure?')"
                            asp-page-handler="Delete"
                            asp-route-id="@recap.RecapID"
                            asp-route-isHardware="@recap.IsHardware">
                        Delete
                    </button>
                </form>-->
            }

            <!--END OF ADMINPRIVS-->
            <hr style="border: 1px solid white; opacity: 1;" />
        }
        else
        {
            <div class="row my-2">

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapWorkorderNumber">Workorder Number:</label>
                        <label class="form-label" id="LabelText">@recap.RecapWorkorderNumber</label>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapDate">Recap Date:</label>
                        <label class="form-label" id="LabelText">@recap.RecapDate.ToString("MM/dd/yyyy")</label>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.Customer">Customer:</label>
                        <label class="form-label" id="LabelText">@recap.Customer</label>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapDescription">Recap Description:</label>
                        <label class="form-label" id="LabelText">@recap.RecapDescription</label>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapState">Recap State:</label>
                        <label class="form-label" id="LabelText">@recap.RecapState</label>
                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText" asp-for="@recap.RecapCity">Recap City:</label>
                        <label class="form-label" id="LabelText">@recap.RecapCity</label>
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(recap.RecapVehicle))
                {
                    <div class="row my-2">
                        <div class="col-12">
                            <label class="form-label" id="LabelText" asp-for="@recap.RecapVehicle">Vehicle Used: @recap.RecapVehicle</label>
                        </div>
                    </div>
                }

                @if (recap.StartingMileage > 0)
                {
                    <div class="row my-2">
                        <div class="col-8">
                            <label class="form-label" id="LabelText" asp-for="@recap.StartingMileage">Starting Mileage:</label>
                            <label class="form-label" id="LabelText">@recap.StartingMileage</label>
                        </div>
                    </div>
                }

                @if (recap.EndingMileage > 0)
                {
                    <div class="row my-2">
                        <div class="col-8">
                            <label class="form-label" id="LabelText" asp-for="@recap.EndingMileage">Ending Mileage:</label>
                            <label class="form-label" id="LabelText">@recap.EndingMileage</label>
                        </div>
                    </div>
                }

                <div class="row my-2">
                    <div class="col-8">
                        <label class="form-label" id="LabelText">@Html.Raw(recap.Segments)</label>

                    </div>
                </div>

                <div class="row my-2">
                    <div class="col-12">
                        <label class="form-label" id="LabelText" asp-for="@recap.TotalWorkTime">Total Work Time:</label>
                        <label class="form-label" id="LabelText">@recap.TotalWorkTime Hour(s)</label>
                        @if (recap.TotalLunchTime > 0)
                        {
                            <label class="form-label" id="LabelText" asp-for="@recap.TotalLunchTime">| Total Lunch Time:</label>
                            <label class="form-label" id="LabelText">@recap.TotalLunchTime Hour(s)</label>
                        }

                        @if (recap.TotalDriveTime > 0)
                        {
                            <label class="form-label" id="LabelText" asp-for="@recap.TotalDriveTime">| Total Travel Time:</label>
                            <label class="form-label" id="LabelText">@recap.TotalDriveTime Hour(s)</label>
                        }

                        @if (recap.TotalSupportTime > 0)
                        {
                            <label class="form-label" id="LabelText" asp-for="@recap.TotalSupportTime">| Total Support Time:</label>
                            <label class="form-label" id="LabelText">@recap.TotalSupportTime Hour(s)</label>
                        }
                        <label class="form-label" id="LabelText" asp-for="@recap.TotalRecapTime">| Total Recap Time:</label>
                        <label class="form-label" id="LabelText">@recap.TotalRecapTime Hour(s)</label>

                        <label class="form-label" id="LabelText" asp-for="@recap.TotalDriveTime">| Total Time:</label>
                        <label class="form-label" id="LabelText">@recap.TotalTime Hour(s)</label>
                    </div>
                </div>

                @{
                    // Build list of cable output strings
                    var cableParts = new List<string>();

                    if (recap.Total182 > 0) cableParts.Add($"18/2: {recap.Total182}'");
                    if (recap.Total184 > 0) cableParts.Add($"18/4: {recap.Total184}'");
                    if (recap.Total186 > 0) cableParts.Add($"18/6: {recap.Total186}'");
                    if (recap.TotalCat6 > 0) cableParts.Add($"Cat 6: {recap.TotalCat6}'");
                    if (recap.TotalFiber > 0) cableParts.Add($"Fiber: {recap.TotalFiber}'");
                    if (recap.TotalCoax > 0) cableParts.Add($"Coax: {recap.TotalCoax}'");

                    var cableOutput = string.Join(" | ", cableParts);
                }

                @if (!string.IsNullOrWhiteSpace(cableOutput))
                {
                    <div class="row my-2">
                        <div class="col-12">
                            <label class="form-label" id="LabelText">Cable Used (feet): @cableOutput</label>
                        </div>
                    </div>
                }

                <div class="col">
                    <label class="form-label" id="LabelText" asp-for="@recap.RecapEmployees">Employees:</label>
                    @foreach (var employees in recap.RecapEmployees)
                    {
                        <span class="badge bg-secondary"> @employees</span>
                    }
                </div>

            </div>
            <!--ADMINPRIVS-->
            var isAdmin = ViewData["IsAdmin"] != null && (bool)ViewData["IsAdmin"];
            @if (isAdmin)
            {
                <!--<form method="post">
                    <button class="deleteBtn btn-danger"
                            onclick="return confirm('Are you sure?')"
                            asp-page-handler="Delete"
                            asp-route-id="@recap.RecapID"
                            asp-route-recapType="@(recap.IsHardwareRecap ? "Hardware" : "Standard")">
                        Delete
                    </button>
                </form>-->
            }
            <!--END OF ADMINPRIVS-->
            <hr style="border: 1px solid white; opacity: 1;" />
        }

    }
    @if (Model.TotalCount > 0)
    {
        <div class="text-center my-4">
            <div class="nacspace-logo mb-3">
                <span class="nacspace-color">N</span>
                <span class="nacspace-color">a</span>
                <span class="nacspace-color">c</span>
                <span class="nacspace-color">S</span>
                <span class="nacspace-color">p</span>
                <span class="nacspace-color">a</span>
                <span class="nacspace-color">c</span>
                <span class="nacspace-color">e</span>
            </div>

            <div class="pagination justify-content-center">
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    if (i == Model.PageNumber)
                    {
                        <span class="page-number active">@i</span>
                    }
                    else
                    {
                        <a class="page-number"
                           asp-page="./BrowseRecaps"
                           asp-route-pageNumber="@i"
                           asp-route-pageSize="@Model.PageSize">@i</a>
                    }
                }
            </div>
        </div>
    }
}
else
{
    <div class="row my-2">
        <div class="col-12 text-center">
            <label class="form-label" id="LabelText">No Recaps yet.</label>
        </div>
    </div>
}